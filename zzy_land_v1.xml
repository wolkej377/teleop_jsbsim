<?xml version="1.0" encoding="UTF-8"?>
<?xml-stylesheet type="text/xsl" href="http://jsbsim.sf.net/JSBSimScript.xsl"?>
<runscript xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
    xsi:noNamespaceSchemaLocation="http://jsbsim.sf.net/JSBSimScript.xsd"
    name="C310 高速直线自动降落程序">

   <description>
    从1.2海里、130节高速开始的简化直线降落。
    飞机将积极减速，飞越“闸口点”，然后降落并全力刹车。
  </description>
  <use aircraft="c310" initialize="land_v1"/>

  <run start="0.0" end="1000" dt="0.01">

    <!-- 阶段 0: 引擎和自动驾驶初始化 -->
    <event name="0. Initial Setup">
      <description>
        启动引擎并设置初始航向和航点，开启航向保持模式。
      </description>
      <condition>simulation/sim-time-sec ge 0.25</condition>
      <set name="fcs/mixture-cmd-norm[0]" value="1"/>
      <set name="fcs/mixture-cmd-norm[1]" value="1"/>
      <set name="fcs/advance-cmd-norm[0]" value="1.0"/>
      <set name="fcs/advance-cmd-norm[1]" value="1.0"/>
      <set name="propulsion/magneto_cmd" value="3"/>
      <set name="fcs/throttle-cmd-norm[0]" value="0.85"/>
      <set name="fcs/throttle-cmd-norm[1]" value="0.85"/>
      <set name="propulsion/starter_cmd" value="1"/>

      <set name="ap/altitude_setpoint" value="550.0"/>
      <set name="ap/altitude_hold" value="1"/>
      <set name="ap/attitude_hold" value="0"/>

      <!-- 随便设置一个远点的wp，防止飞机在起飞后乱窜-->
      <set name="guidance/target_wp_latitude_rad" value="0.5168"/>
      <set name="guidance/target_wp_longitude_rad" value="-1.6599238 "/>
      <set name="ap/heading_setpoint" value="0"/>
      <set name="ap/heading_hold" value="1"/>
      <set name="ap/heading-setpoint-select" value="1"/>
      <set name="ap/active-waypoint" value="0"/>
    </event>

    <!-- 阶段 1: 飞向“闸口点” (WP1) - 重点是减速 -->
    <event name="1. Fly to The Gate (WP1) and Decelerate">
      <description>
        设置第一个航点为“闸口点”，并配置飞机以最大程度减速。
      </description>
      <condition> simulation/sim-time-sec ge 2.0 </condition>
      <!-- WP1: "The Gate" 坐标，位于着陆点(29.6)南方0.75海里 -->
      <set name="guidance/target_wp_latitude_rad" value="0.51642159"/>
      <set name="guidance/target_wp_longitude_rad" value="-1.6599238"/>
      <set name="ap/active-waypoint" value="1"/>
      <!-- 配置减速：放下起落架，放襟翼，并将油门收至较低水平 -->
      <set name="gear/gear-cmd-norm" value="1"/>
      <set name="fcs/flap-cmd-norm" action="FG_EXP" value="1" tc="3.0"/>
      <set name="fcs/throttle-cmd-norm[0]" action="FG_EXP" value="0.6" tc="5.0"/>
      <set name="fcs/throttle-cmd-norm[1]" action="FG_EXP" value="0.6" tc="5.0"/>
      <!-- 设置目标高度为闸口点高度380ft -->
      <set name="ap/altitude_setpoint" action="FG_EXP" value="380.0" tc="6.0"/>
    </event>

   <!-- 阶段 2: 从“闸口点”飞向着陆点 (WP2) -->
    <event name="2. Final Approach to Touchdown (WP2)">
      <description>
        越过“闸口点”后，设置最终着陆点，并以接近怠速的油门进行最后下降。
      </description>
      <condition>
        guidance/wp-distance lt 500
        ap/active-waypoint eq 1
      </condition>
      <!-- WP2: "Touchdown Point" 坐标 -->
      <set name="guidance/target_wp_latitude_rad" value="0.5166114"/>
      <set name="guidance/target_wp_longitude_rad" value="-1.6599238"/>
      <set name="ap/active-waypoint" value="2"/>
      <!-- 设置目标高度为0，模拟最后的着陆下滑 -->
      <set name="ap/altitude_setpoint" action="FG_EXP" value="30.0" tc="10.0"/>
      <!-- 油门收至接近怠速，以达到安全着陆速度 -->
      <set name="fcs/throttle-cmd-norm[0]" action="FG_EXP" value="0.55" tc="8.0"/>
      <set name="fcs/throttle-cmd-norm[1]" action="FG_EXP" value="0.55" tc="8.0"/>
    </event>

    <!-- 阶段 3: 着陆后减速 -->
    <event name="3. Touchdown and Deceleration">
      <description>
        当飞机高度低于5英尺且速度已降至80节(135英尺/秒）以下时，执行全力减速。
      </description>
      <condition>
        ap/active-waypoint eq 2
        position/h-agl-ft lt 20.0
        velocities/vc-kts lt 80
      </condition>
      <set name="ap/altitude_setpoint" action="FG_EXP" value="0.0" tc="2.0"/>
      <set name="ap/altitude_hold" value="0"/>
      <set name="fcs/throttle-cmd-norm[0]" action="FG_EXP" value="0.25" tc="1.0"/>
      <set name="fcs/throttle-cmd-norm[1]" action="FG_EXP" value="0.25" tc="1.0"/>
    </event>

    <event name="接地后反推">
      <condition>
        position/h-agl-ft lt 15.0
        velocities/vc-kts lt 80
      </condition>
      <set name="fcs/throttle-cmd-norm[0]" value="0.0"/>
      <set name="fcs/throttle-cmd-norm[1]" value="0.0"/>
      <set name="fcs/speedbrake-cmd-norm" value="1.0"/>
      <set name="fcs/left-brake-cmd-norm" value="1.0"/>
      <set name="fcs/right-brake-cmd-norm" value="1.0"/>
      <notify format="kml">
        <property caption="position/h-agl-ft"> position/h-agl-ft </property>
        <property caption="velocities/vc-kts"> velocities/vc-kts </property>
      </notify>
    </event>

    <!-- 阶段 4: 停止仿真 -->
    <event name="4. End Simulation">
      <description>当飞机在地面上减速到很低的速度时，结束仿真。</description>
      <condition>
        position/h-agl-ft lt 5.0
<!--        velocities/vc-kts lt 50     这一项并不起作用，速度降不下来-->
      </condition>
      <set name="simulation/terminate" value="1"/>
      <notify format="kml">
        <property caption="position/h-agl-ft"> position/h-agl-ft </property>
        <property caption="velocities/vc-kts"> velocities/vc-kts </property>
      </notify>
    </event>

  </run>

  <output name="c3104_waypoint.csv" type="CSV" rate="100" file="unitconversions.xml">
    <velocities> ON </velocities>
    <position> ON </position>
    <property caption="guidance/wp-distance">guidance/wp-distance</property>
    <property caption="ap/active-waypoint">ap/active-waypoint</property>
    <property caption="position/h-agl-ft">position/h-agl-ft</property>
    <property caption="ap/altitude_setpoint">ap/altitude_setpoint</property>
    <property caption="velocities/vc-kts">velocities/vc-kts</property>
    <property caption="attitude/theta-deg">attitude/theta-deg</property>
    <property caption="fcs/throttle-cmd-norm[0]">fcs/throttle-cmd-norm[0]</property>
    <property caption="fcs/flap-pos-norm">fcs/flap-pos-norm</property>
    <property caption="gear/gear-pos-norm">gear/gear-pos-norm</property>

    <property caption="velocities/p-rad_sec">velocities/p-rad_sec</property>
    <property caption="velocities/q-rad_sec">velocities/q-rad_sec</property>
    <property caption="velocities/r-rad_sec">velocities/r-rad_sec</property>
    <property caption="accelerations/udot-ft_sec2">accelerations/udot-ft_sec2</property>
    <property caption="accelerations/vdot-ft_sec2">accelerations/vdot-ft_sec2</property>
    <property caption="accelerations/wdot-ft_sec2">accelerations/wdot-ft_sec2</property>
  </output>
</runscript>